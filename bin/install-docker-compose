#!/bin/bash
cd "$(dirname "${BASH_SOURCE[0]}")"
source ../lib/devbox-setup-utils.sh
devbox-setup-init

require-root

DOCKER_COMPOSE_VERSION="1.23.2"
EXPECTED_SHA256="4d618e19b91b9a49f36d041446d96a1a0a067c676330a4f25aca6bbd000de7a9"

log 'Preparing temporary dirtectoy'
TMPDIR="$(mktemp -d)"
if [[ -z "$TMPDIR" ]] || [[ "$TMPDIR" == "/" ]] || [[ "$TMPDIR" == "/tmp" ]]; then
  fatal "Unable to generate temp directory, got $TMPDIR"
fi

log "Downloading docker-compose $DOCKER_COMPOSE_VERSION"
curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" \
  -o "$TMPDIR/docker-compose"

log "Performing integrity check"
echo "$EXPECTED_SHA256 *$TMPDIR/docker-compose" | sha256sum --check --strict

log 'Installing docker-compose'
mv "$TMPDIR/docker-compose" '/usr/local/bin/docker-compose'
chmod +x '/usr/local/bin/docker-compose'

log 'Cleaning up temporary directory'
rmdir "$TMPDIR"
